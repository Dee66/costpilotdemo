# Copyright (c) 2025 CostPilot Demo Team
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.

id: costpilot.demo.checklist.v1
version: "1.0.0"
source_spec: "costpilot-demo-spec.yml"


# 1. REPOSITORY INITIALIZATION

repo_setup:
  - create_repo_structure
  - initialize_git
  - create_main_branch
  - set_branch_protection_rules_for_main

initial_directories:
  - mkdir_infrastructure_terraform_baseline
  - mkdir_infrastructure_terraform_pr_change
  - mkdir_infrastructure_terraform_noop_change
  - mkdir_snapshots
  - mkdir_costpilot_demo
  - mkdir_costpilot_artifacts
  - mkdir_tools
  - mkdir_github_workflows

required_files:
  - create_README_md
  - create_costpilot_yml
  - create_reset_demo_sh
  - create_costpilot_ci_yml


# 2. TERRAFORM ENVIRONMENTS

terraform_baseline_stack:
  - write_main_tf_baseline
  - write_variables_tf_baseline
  - write_outputs_tf_baseline
  - ensure_low_cost_resources
  - include_autoscaling_group
  - include_alb_target_group_listener
  - include_s3_with_lifecycle_enabled
  - include_cloudwatch_log_30day_retention
  - validate_terraform_format_baseline

terraform_pr_change_stack:
  - write_main_tf_pr_change
  - add_ec2_instance_upgrade_regression
  - disable_s3_lifecycle_regression
  - increase_cloudwatch_retention_regression
  - increase_ebs_volume_size_regression
  - maintain_cross_service_dependencies
  - validate_terraform_format_pr_change

terraform_noop_change_stack:
  - write_main_tf_noop
  - guarantee_no_semantic_cost_differences
  - validate_terraform_format_noop

terraform_requirements_validation:
  - enforce_minimum_version_1_6
  - enforce_plan_schema_version_2


# 3. SNAPSHOT GENERATION

snapshots_generation:
  - generate_plan_before_json
  - generate_plan_after_json
  - generate_plan_diff_json
  - run_costpilot_detect_store_detect_v1_json
  - run_costpilot_predict_store_predict_v1_json
  - run_costpilot_explain_store_explain_v1_json
  - run_costpilot_autofix_snippet_store_snippet_v1_tf
  - run_costpilot_autofix_patch_store_patch_v1_diff
  - generate_mapping_mmd_snapshot
  - generate_trend_history_json
  - generate_trend_svg_snapshot
  - copy_all_snapshots_to_costpilot_demo_directory

snapshot_invariants:
  - enforce_deterministic_hashes
  - enforce_float_precision_2
  - enforce_stable_whitespace
  - enforce_stable_ordering_rules


# 4. TRUST TRIANGLE VERIFICATION

trust_triangle_validation:
  detect_output_must_show:
    - resource_classification
    - rule_ids
    - severity_scoring
  predict_output_must_show:
    - heuristic_references
    - low_and_high_ranges
    - cold_start_assumptions
  explain_output_must_show:
    - root_cause
    - regression_type
    - severity_score
    - heuristic_provenance
    - delta_justification

validation_tasks:
  - verify_detect_output_contains_required_fields
  - verify_predict_output_contains_required_fields
  - verify_explain_output_contains_required_fields


# 5. PATCH PREVIEW IMPLEMENTATION

patch_preview:
  snippet_scope:
    - implement_snippet_generation_ec2_only
    - implement_snippet_generation_s3_only
  patch_mode:
    - generate_patch_diff
    - simulate_patch_application
    - generate_simulation_output_json
    - include_before_and_after_hashes
    - include_patch_id
    - include_rollback_patch

patch_scope_limit_rationale:
  - document_reason_for_scope_limit_in_README


# 6. MAPPING ENGINE DEMO

mapping_demo:
  - ensure_cross_service_dependencies_exist
  - run_costpilot_map_mermaid
  - fix_mermaid_layout_seed
  - store_output_mapping_mmd
  - copy_to_snapshots_and_demo

mapping_validation:
  - ensure_no_cycles
  - ensure_deterministic_node_ordering


# 7. TREND ENGINE DEMO

trend_demo:
  variations:
    - generate_flat_trend
    - generate_upward_trend
    - generate_slo_breach_trend
  constraints:
    - fixed_layout_seed
    - fixed_svg_dimensions_800_300
    - deterministic_coloring

trend_tasks:
  - create_trend_history_json
  - create_trend_svg_snapshot
  - validate_trend_is_deterministic


# 8. RESET SCRIPT IMPLEMENTATION

reset_demo_script:
  path: tools/reset_demo.sh
  must_implement:
    - restore_baseline_infrastructure
    - regenerate_all_snapshots
    - regenerate_mapping
    - regenerate_trend_history
    - validate_deterministic_hashes
    - exit_nonzero_on_drift

permissions:
  - chmod_plus_x_reset_demo_sh


# 9. CI PIPELINE IMPLEMENTATION

ci_pipeline:
  path: .github/workflows/costpilot-ci.yml
  tasks:
    - configure_terraform_init
    - run_costpilot_scan
    - run_costpilot_diff
    - run_costpilot_explain
    - enforce_noop_expected_no_findings
    - verify_deterministic_output_against_snapshots
    - block_on_any_drift

ci_guardrails:
  prevent_updates_to:
    - snapshots/*
    - costpilot_artifacts/*
    - video_assets/*
  allowlist:
    - infrastructure/terraform/pr-change/*
    - README.md
    - costpilot.yml


# 10. ARTIFACT GENERATION PIPELINE

artifacts_pipeline:
  - generate_output_detect_json
  - generate_output_predict_json
  - generate_output_explain_json
  - generate_output_snippet_tf
  - generate_output_patch_diff
  - generate_output_mapping_mmd
  - generate_output_trend_json
  - ensure_all_artifacts_hash_stable

artifact_constraints:
  - store_all_artifacts_in_costpilot_artifacts
  - ensure_no_overwrite_drift_over_time


# 11. README IMPLEMENTATION

readme_tasks:
  - write_hero_copy
  - add_statement_of_purpose
  - add_quickstart_section
  - add_pr_walkthrough_section
  - add_mapping_example
  - add_trend_example
  - add_trust_triangle_section
  - include_scope_limit_explanation
  - include_scenario_versioning_notice

readme_validation:
  - confirm_clarity
  - confirm_asset_paths_correct
  - confirm_no_enterprise_features_mentioned


# 12. VERSIONING & CHECKSUM

scenario_versioning:
  - embed_scenario_version_in_snapshots
  - embed_scenario_version_in_README

canonical_hash_generation:
  - compute_canonical_spec_hash
  - insert_hash_into_spec
  - verify_snapshots_match_hash
  - verify_explain_output_matches_hash


# 13. FINAL REVIEW & QA

qa_tasks:
  - run_reset_demo_script_fresh
  - re-run_costpilot_scan_all_modes
  - revalidate_trust_triangle
  - validate_noop_does_not_trigger_findings
  - open_mapping_svg_to_validate_layout
  - validate_consistency_of_hashes
  - run_ci_locally
  - test_repo_on_clean_machine

drift_protection:
  - enforce_all_outputs_reproducible_on_3_runs
  - commit_final_snapshots
  - tag_v1_demo_release
