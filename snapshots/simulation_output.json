{
  "format_version": "1.0",
  "scenario_version": "v1",
  "timestamp": "2025-12-06T16:47:00Z",
  "patch_simulation": {
    "patch_id": "patch_v1_20251206_164700",
    "source_file": "infrastructure/terraform/pr-change/main.tf",
    "patch_file": "snapshots/patch_v1.diff",
    "simulation_status": "success",
    "applies_cleanly": true,
    "before_hash": "sha256:d4f2c8b1a9e7f3c0b5a2d8e1f4c7b9a0",
    "after_hash": "sha256:b7e3f1a2c8d9f0c5a7b3d1e8f2c4a9b1",
    "changes_applied": [
      {
        "resource": "aws_launch_template.main",
        "attribute": "instance_type",
        "before": "t3.xlarge",
        "after": "t3.large",
        "line_number": 126,
        "change_type": "value_modification"
      },
      {
        "resource": "aws_launch_template.main",
        "attribute": "block_device_mappings[0].ebs.volume_size",
        "before": 200,
        "after": 50,
        "line_number": 138,
        "change_type": "value_modification"
      },
      {
        "resource": "aws_cloudwatch_log_group.application",
        "attribute": "retention_in_days",
        "before": 0,
        "after": 30,
        "line_number": 245,
        "change_type": "value_modification"
      },
      {
        "resource": "aws_s3_bucket_lifecycle_configuration.main",
        "attribute": "(entire resource)",
        "before": null,
        "after": "resource created",
        "line_number": 254,
        "change_type": "resource_addition"
      }
    ],
    "rollback_patch": {
      "patch_id": "rollback_patch_v1_20251206_164700",
      "description": "Rollback patch to revert all changes from patch_v1",
      "patch_content": "--- a/infrastructure/terraform/pr-change/main.tf\n+++ b/infrastructure/terraform/pr-change/main.tf\n@@ -123,7 +123,7 @@ data \"aws_ami\" \"amazon_linux_2\" {\n resource \"aws_launch_template\" \"main\" {\n   name_prefix   = \"costpilot-demo-\"\n   image_id      = data.aws_ami.amazon_linux_2.id\n-  instance_type = \"t3.large\"\n+  instance_type = \"t3.xlarge\"\n \n   user_data = base64encode(<<-EOF\n     #!/bin/bash\n@@ -135,7 +135,7 @@ resource \"aws_launch_template\" \"main\" {\n \n   block_device_mappings {\n     device_name = \"/dev/xvda\"\n     ebs {\n-      volume_size           = 50\n+      volume_size           = 200\n       volume_type           = \"gp3\"\n       delete_on_termination = true\n       encrypted             = true\n@@ -242,7 +242,7 @@ resource \"aws_s3_bucket_versioning\" \"main\" {\n \n resource \"aws_cloudwatch_log_group\" \"application\" {\n   name              = \"/aws/costpilot-demo/application\"\n-  retention_in_days = 30\n+  retention_in_days = 0\n \n   tags = {\n     Name        = \"costpilot-demo-logs\"\n@@ -250,46 +250,6 @@ resource \"aws_cloudwatch_log_group\" \"application\" {\n   }\n }\n \n-# S3 Lifecycle Configuration (restored)\n-resource \"aws_s3_bucket_lifecycle_configuration\" \"main\" {\n-  bucket = aws_s3_bucket.main.id\n-\n-  rule {\n-    id     = \"transition-old-objects\"\n-    status = \"Enabled\"\n-\n-    transition {\n-      days          = 90\n-      storage_class = \"GLACIER_IR\"\n-    }\n-\n-    transition {\n-      days          = 180\n-      storage_class = \"GLACIER\"\n-    }\n-\n-    expiration {\n-      days = 365\n-    }\n-  }\n-\n-  rule {\n-    id     = \"cleanup-incomplete-uploads\"\n-    status = \"Enabled\"\n-\n-    abort_incomplete_multipart_upload {\n-      days_after_initiation = 7\n-    }\n-  }\n-\n-  rule {\n-    id     = \"expire-old-versions\"\n-    status = \"Enabled\"\n-\n-    noncurrent_version_expiration {\n-      noncurrent_days = 90\n-    }\n-  }\n-}\n-\n # Outputs\n output \"vpc_id\" {\n   description = \"ID of the VPC\"\n",
      "applies_cleanly": true,
      "estimated_cost_impact": "+$335.46/month (reverts optimizations)"
    },
    "cost_impact_analysis": {
      "before_monthly_cost": 387.89,
      "after_monthly_cost": 52.43,
      "monthly_savings": 335.46,
      "annual_savings": 4025.52,
      "confidence": "high",
      "breakdown": [
        {
          "resource": "aws_launch_template.main (instance_type)",
          "savings": 113.85,
          "percentage_of_total": 33.9
        },
        {
          "resource": "aws_launch_template.main (ebs_volume)",
          "savings": 21.60,
          "percentage_of_total": 6.4
        },
        {
          "resource": "aws_cloudwatch_log_group.application",
          "savings": 145.00,
          "percentage_of_total": 43.2
        },
        {
          "resource": "aws_s3_bucket_lifecycle_configuration.main",
          "savings": 20.00,
          "percentage_of_total": 6.0
        }
      ]
    },
    "terraform_validation": {
      "fmt_check": "passed",
      "validate_check": "passed",
      "plan_generated": true,
      "plan_shows_changes": true,
      "expected_changes": {
        "resources_modified": 3,
        "resources_added": 1,
        "resources_destroyed": 0
      }
    },
    "safety_checks": {
      "no_resource_deletion": true,
      "no_data_loss_risk": true,
      "reversible": true,
      "idempotent": true,
      "drift_safe": true
    },
    "metadata": {
      "simulation_duration_ms": 234,
      "patch_application_method": "deterministic_text_replacement",
      "validation_engine_version": "1.0.0",
      "terraform_version": "1.6.0"
    }
  }
}
