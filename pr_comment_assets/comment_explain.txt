ü§ñ **CostPilot Root Cause Analysis ‚Äî PR #42**

**Branch**: `feature/upgrade-instances` ‚Üí `main`  
**Purpose**: Explain *why* costs are changing and provide context

---

## üí° Executive Summary

This PR introduces **4 cost regressions** that increase monthly infrastructure costs by **+$335.46 (+639.82%)**. The changes fall into two categories:

1. **Immediate Impact** (Month 1): EC2 instance upgrade and EBS volume expansion
2. **Time Bomb Impact** (Compounds over time): S3 lifecycle removal and infinite log retention

---

## üîç Root Cause Analysis

### 1. EC2 Instance Type Upgrade (HIGH)

**Why is this changing?**
- Developer upgraded from `t3.micro` to `t3.xlarge` for "better performance"
- Likely motivated by application performance concerns or load testing

**Why does this cost more?**
- t3.micro: 2 vCPU, 1GB RAM ‚Üí $0.0104/hr
- t3.xlarge: 4 vCPU, 16GB RAM ‚Üí $0.1664/hr
- **16x more expensive per instance**

**Cross-Service Impact**:
```
Auto Scaling Group (min: 2, max: 4)
  ‚îú‚îÄ Launch Template ‚Üí t3.xlarge (16x cost)
  ‚îú‚îÄ EBS Volumes ‚Üí 200GB each (10x cost)
  ‚îî‚îÄ CloudWatch Logs ‚Üí Infinite retention
```

The instance type change affects **every instance** in the ASG, multiplying the cost impact.

**Heuristic Provenance**:
- Source: AWS EC2 On-Demand Pricing (us-east-1)
- Reference: `ec2-pricing-on-demand-t3-family`
- Confidence: **High** (deterministic pricing)

**Severity Justification**: **HIGH**
- Policy violation: `default-ec2-type` mandates t3.micro
- Large cost delta: +$227.96/month
- Affects multiple instances (2-4)
- No documented exemption

---

### 2. S3 Lifecycle Removal (HIGH)

**Why is this changing?**
- Lifecycle configuration resource **deleted** entirely
- Previously configured to expire objects after 90 days

**Why does this cost more?**
- **Before**: Objects auto-deleted after 90 days ‚Üí predictable storage
- **After**: Objects accumulate indefinitely ‚Üí unbounded growth

**Time Bomb Analysis**:
```
Month 1:  10GB/day √ó 30 days = 300GB ‚Üí $6.90/month
Month 6:  10GB/day √ó 180 days = 1,800GB ‚Üí $41.40/month  
Month 12: 10GB/day √ó 360 days = 3,600GB ‚Üí $82.80/month
Month 24: 10GB/day √ó 720 days = 7,200GB ‚Üí $165.60/month
```

**Key Risk**: This regression **compounds monthly**. Small impact initially, but grows to exceed entire baseline cost within 18 months.

**Heuristic Provenance**:
- Source: AWS S3 Standard Storage Pricing
- Assumption: 10GB/day ingestion rate (based on typical log/analytics workloads)
- Reference: `s3-storage-growth-without-lifecycle`
- Confidence: **Medium** (depends on actual data ingestion rate)

**Severity Justification**: **HIGH**
- Long-term financial risk
- No automatic remediation (requires manual intervention)
- Impacts business unit budget planning

---

### 3. EBS Volume Size Increase (MEDIUM)

**Why is this changing?**
- Volume size increased from 20GB to 200GB (10x)
- Likely anticipating higher storage needs for application data

**Why does this cost more?**
- **Before**: 2 volumes √ó 20GB √ó $0.10/GB = $4.00/month
- **After**: 2 volumes √ó 200GB √ó $0.10/GB = $40.00/month
- Delta: **+$36.00/month**

**Right-Sizing Question**:
- Is 200GB actually needed, or is 50GB sufficient?
- Consider: Application data size, log rotation, temp file cleanup

**Heuristic Provenance**:
- Source: AWS EBS gp3 Pricing (us-east-1)
- Reference: `ebs-gp3-per-gb-month`
- Confidence: **High** (deterministic pricing)

**Severity Justification**: **MEDIUM**
- Moderate cost delta (+$36/month)
- May be justified if storage is genuinely needed
- Consider right-sizing to 50GB first (saves $15/month)

---

### 4. CloudWatch Log Retention Infinite (MEDIUM)

**Why is this changing?**
- Log retention changed from 30 days to 0 (infinite)
- Value 0 means "never expire"

**Why does this cost more?**
- **Before**: Logs auto-deleted after 30 days ‚Üí stable storage
- **After**: Logs kept forever ‚Üí cumulative growth

**Time Bomb Analysis** (assumes 500MB/day):
```
Month 1:  15GB stored ‚Üí $7.50/month
Month 6:  90GB stored ‚Üí $45/month
Month 12: 180GB stored ‚Üí $90/month
Month 24: 360GB stored ‚Üí $180/month
```

**Debugging vs Cost Trade-off**:
- Infinite retention helps with long-term debugging
- But costs grow unbounded over time
- **Recommendation**: Set retention to 90-180 days (balances both needs)

**Heuristic Provenance**:
- Source: AWS CloudWatch Logs Pricing
- Assumption: 500MB/day log generation (typical for web services)
- Reference: `cloudwatch-logs-storage-per-gb`
- Confidence: **Medium** (depends on actual log volume)

**Severity Justification**: **MEDIUM**
- Moderate initial impact
- Compounds over time (similar to S3)
- Easier to remediate (just set retention_in_days)

---

## üéØ Delta Justification

### Why This PR Costs 6.4x More

| Component | Delta | Reasoning |
|-----------|-------|-----------|
| **EC2** | +$228/mo | 16x more expensive per instance √ó 2 instances |
| **EBS** | +$36/mo | 10x more storage per volume √ó 2 volumes |
| **S3** | +$7/mo (Mth 1) | Lifecycle removed ‚Üí objects accumulate |
| **CloudWatch** | +$10/mo (Mth 1) | Infinite retention ‚Üí logs accumulate |
| **Total (Month 1)** | **+$281/mo** | Immediate impact |
| **Total (Month 12)** | **+$442/mo** | With compounding storage costs |

**Key Insight**: The immediate impact (+$264/mo) is from EC2/EBS. The long-term impact (+$178/mo by Month 12) is from S3/CloudWatch accumulation.

---

## üîó Baseline & Policy Context

### Baseline Comparison
- **Recorded Baseline**: $52.43/month (cost-efficient, stable)
- **This PR**: $387.89/month (Month 1)
- **Deviation**: +639.82% from baseline

### Policy Violations
**Policy**: `default-ec2-type`
- **Rule**: EC2 instances should use t3.micro unless exemption approved
- **Violated By**: `aws_launch_template.main` (t3.micro ‚Üí t3.xlarge)
- **Required Action**: Document exemption justification OR revert change

---

## üìä Cross-Service Dependency Explanation

The changes in this PR create cascading cost impacts:

**ALB ‚Üí Target Group ‚Üí ASG ‚Üí EC2 Flow**:
- ALB routes traffic to Target Group
- Target Group connects to Auto Scaling Group
- ASG launches EC2 instances using Launch Template
- **Impact**: Instance type change affects ALL instances in ASG

**EC2 ‚Üí EBS ‚Üí CloudWatch Flow**:
- Each EC2 instance has attached EBS volume
- Each EC2 instance sends logs to CloudWatch
- **Impact**: Volume size and log retention affect per-instance costs

**S3 Analytics Flow**:
- Application generates analytics data daily
- Data stored in S3 bucket
- **Impact**: Without lifecycle, data accumulates indefinitely

---

## üõ†Ô∏è Recommended Actions

### Option 1: Full Remediation (Recommended)
Apply all auto-fix suggestions to restore cost efficiency:
- ‚úÖ Revert to t3.micro
- ‚úÖ Restore S3 lifecycle (90-day expiration)
- ‚úÖ Right-size EBS to 50GB
- ‚úÖ Set log retention to 90 days
- **Result**: **~$70/month** (under baseline, with new features)

### Option 2: Partial Remediation
Keep performance improvements but mitigate storage growth:
- üü° Keep t3.xlarge (if justified and exemption documented)
- ‚úÖ Restore S3 lifecycle
- ‚úÖ Set log retention to 90 days
- **Result**: **~$270/month** (higher than baseline but controlled growth)

### Option 3: Document Justification
If all changes are intentional:
- ‚úÖ Document business case for t3.xlarge
- ‚úÖ Get policy exemption approval
- ‚úÖ Set up cost alerts at $350/month and $450/month
- ‚úÖ Plan for Month 12 cost of ~$520/month
- **Result**: Accept higher costs with monitoring

---

## üìà Historical Context

**Baseline Stack** (before this PR):
- Launched on: 2025-12-06
- Monthly Cost: $52.43
- Architecture: Cost-efficient, right-sized resources
- Performance: Adequate for current workload

**This PR** introduces:
- Performance improvements (more CPU, more RAM)
- Storage capacity increases
- BUT: No lifecycle or retention limits

**Question to ask**: Do we need the performance improvements? Are there cheaper alternatives (e.g., optimizing application code instead of upsizing instances)?

---

‚öôÔ∏è **CostPilot v1.0.0** | Explanation completed in 250ms  
üîç [View Detection Details](#) | üìä [View Cost Predictions](#) | üîß [Auto-Fix Suggestions](#)
